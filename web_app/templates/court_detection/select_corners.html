<!DOCTYPE html>
<html>
<head>
    <title>Select Corners</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #frame-container {
            position: relative;
            margin: 0 auto;
            max-width: 1000px; /* Aumentato da 640px a 1000px */
            width: 100%;
        }
        .corner {
            width: 10px;
            height: 10px;
            background: red;
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Select Corners of the Basketball Court</h1>
        <div id="frame-container" class="border">
            <img id="frame" src="{{ frame_url }}" width="100%" alt="Video Frame">
        </div>
        <button id="save-corners" class="btn btn-success btn-block mt-4">Save Corners</button>
        <button id="reset-corners" class="btn btn-danger btn-block mt-2">Reset Corners</button>
    </div>

    <script>
        const frameContainer = document.getElementById('frame-container');
        const frame = document.getElementById('frame');
        let corners = [];
        let num_corners = 4;

        frame.onload = function() {
            const aspectRatio = frame.naturalWidth / frame.naturalHeight;
            frameContainer.style.height = (frameContainer.offsetWidth / aspectRatio) + 'px';
        };

        frameContainer.addEventListener('click', function(event) {
            if (corners.length < num_corners) {
                const rect = frameContainer.getBoundingClientRect();
                const x = (event.clientX - rect.left) / rect.width;
                const y = (event.clientY - rect.top) / rect.height;
                
                const corner = document.createElement('div');
                corner.className = 'corner';
                corner.style.left = (x * 100) + '%';
                corner.style.top = (y * 100) + '%';
                frameContainer.appendChild(corner);
                
                corners.push({x: x, y: y});
                console.log(`Corner ${corners.length} added: (${x.toFixed(4)}, ${y.toFixed(4)})`);
            }
        });

        document.getElementById('save-corners').addEventListener('click', function() {
            if (corners.length !== num_corners) {
                alert(`Please select all 16 corners. Current count: ${corners.length}`);
                return;
            }

            console.log('Sending corners:', corners);

            fetch("{% url 'save_corners' game.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({corners: corners}),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response:', data);
                if (data.status === 'success') {
                    alert('Corners saved successfully!');
                    window.location.href = "{% url 'top_view' game.id %}";
                } else {
                    alert('Failed to save corners: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving corners.');
            });
        });

        document.getElementById('reset-corners').addEventListener('click', function() {
            corners = [];
            const existingCorners = frameContainer.querySelectorAll('.corner');
            existingCorners.forEach(corner => corner.remove());
            console.log('Corners reset');
        });
    </script>
</body>
</html>